<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>HYDROGUARD â€” Flood Early Warning System</title>
    <meta name="description" content="AI-powered real-time flood monitoring with triple-redundant alerts">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "panel-dark": "#161f2e",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #101622;
        }

        ::-webkit-scrollbar-thumb {
            background: #2d3748;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a5568;
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(239, 68, 68, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            }
        }

        .alert-glow {
            animation: pulseGlow 1.5s infinite;
        }

        .water-fill {
            transition: height 1s ease-out;
        }

        .water-level-line {
            transition: top 1s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-animate {
            animation: slideInRight 0.3s ease;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-display min-h-screen flex flex-col overflow-x-hidden">

    <!-- Header -->
    <header
        class="h-14 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-panel-dark flex items-center justify-between px-4 sticky top-0 z-30 shadow-md">
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 rounded bg-primary flex items-center justify-center shrink-0">
                <span class="material-icons text-white text-sm">water_drop</span>
            </div>
            <div class="flex flex-col">
                <h1 class="text-sm font-bold tracking-wide leading-none">HYDRO<span class="text-primary">GUARD</span>
                </h1>
                <span class="text-[10px] text-slate-400 font-normal">By Prince Zyrus Natividad</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end">
                <div class="flex items-center gap-1.5">
                    <span id="statusDot" class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span id="statusText"
                        class="text-[10px] uppercase font-bold text-slate-500 dark:text-slate-400">Connecting</span>
                </div>
                <span id="clockDisplay" class="text-[10px] text-slate-400 font-mono">--:--:-- UTC</span>
            </div>
            <button onclick="document.documentElement.classList.toggle('dark')"
                class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center border border-slate-200 dark:border-slate-700">
                <span class="material-icons text-slate-500 text-sm">dark_mode</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 grid grid-cols-1 lg:grid-cols-3 gap-4 pb-32 lg:pb-4">
        <!-- Left Column: Camera + History -->
        <div class="lg:col-span-2 flex flex-col gap-4">
            <!-- Camera Feed -->
            <div
                class="bg-white dark:bg-panel-dark rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-lg flex flex-col h-full">
                <div
                    class="p-3 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
                    <div class="flex items-center gap-2">
                        <span id="liveDot"
                            class="material-icons text-red-500 text-[10px] animate-pulse">fiber_manual_record</span>
                        <span
                            class="text-xs font-semibold uppercase tracking-wider text-slate-700 dark:text-slate-200">Cam
                            01</span>
                        <span id="cameraSourceBadge"
                            class="text-[10px] text-primary bg-primary/10 px-1.5 py-0.5 rounded font-medium hidden">DroidCam</span>
                    </div>
                    <div class="flex items-center gap-2 text-[10px] text-slate-500 font-mono">
                        <span id="resolutionDisplay" class="hidden sm:inline">--</span>
                        <span>FPS:<span id="fpsDisplay" class="text-emerald-500 ml-0.5">--</span></span>
                    </div>
                </div>
                <div class="relative aspect-video bg-black w-full flex-grow">
                    <!-- Live video feed from Flask -->
                    <img id="videoFeed" alt="River camera feed" class="w-full h-full object-contain opacity-90"
                        src="/video_feed">

                    <!-- Overlay waiting message -->
                    <div id="videoOverlay" class="absolute inset-0 bg-black/70 flex items-center justify-center">
                        <div class="text-center">
                            <span
                                class="material-icons text-slate-500 text-4xl mb-2 block animate-pulse">videocam_off</span>
                            <p class="text-slate-400 text-sm">Waiting for camera...</p>
                            <p class="text-slate-500 text-[10px] mt-1">Start DroidCam on your phone</p>
                        </div>
                    </div>

                    <!-- Detection overlay -->
                    <div class="absolute inset-0 pointer-events-none p-3 flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <div id="confBadge"
                                class="bg-black/60 backdrop-blur-sm px-2 py-0.5 rounded border border-white/10 text-white/80 text-[10px] font-mono">
                                CONF: --%
                            </div>
                            <div
                                class="bg-red-500/90 text-white px-1.5 py-0.5 rounded text-[10px] font-bold animate-pulse">
                                LIVE
                            </div>
                        </div>
                    </div>

                    <!-- Grid overlay -->
                    <div
                        class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none">
                    </div>
                </div>
            </div>

            <!-- History Chart (Desktop) -->
            <div
                class="bg-white dark:bg-panel-dark rounded-xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm hidden lg:block">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wide">History
                    </h3>
                    <div class="flex bg-slate-100 dark:bg-slate-900 rounded p-0.5">
                        <button onclick="setChartRange(60)"
                            class="chart-range-btn px-2 py-1 text-[10px] rounded text-slate-500 hover:text-primary dark:hover:text-white transition">1H</button>
                        <button onclick="setChartRange(360)"
                            class="chart-range-btn px-2 py-1 text-[10px] rounded bg-white dark:bg-primary text-primary dark:text-white shadow-sm font-medium active-range">6H</button>
                        <button onclick="setChartRange(1440)"
                            class="chart-range-btn px-2 py-1 text-[10px] rounded text-slate-500 hover:text-primary dark:hover:text-white transition">24H</button>
                    </div>
                </div>
                <div class="relative w-full h-48 border-l border-b border-slate-200 dark:border-slate-700">
                    <!-- Threshold lines -->
                    <div id="critLine"
                        class="absolute w-full border-t border-dashed border-red-500/50 flex items-center"
                        style="top: 20%">
                        <span class="text-[8px] text-red-500 ml-[-28px] absolute font-mono" id="critLabel">290</span>
                    </div>
                    <div id="warnLine"
                        class="absolute w-full border-t border-dashed border-yellow-500/50 flex items-center"
                        style="top: 55%">
                        <span class="text-[8px] text-yellow-500 ml-[-28px] absolute font-mono" id="warnLabel">220</span>
                    </div>
                    <!-- SVG Chart -->
                    <svg id="historyChart" class="absolute inset-0 w-full h-full overflow-visible"
                        preserveAspectRatio="none" viewBox="0 0 1200 100">
                        <defs>
                            <linearGradient id="gradientArea" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="#135bec" stop-opacity="0.2"></stop>
                                <stop offset="100%" stop-color="#135bec" stop-opacity="0"></stop>
                            </linearGradient>
                        </defs>
                        <path id="chartAreaPath" d="" fill="url(#gradientArea)" stroke="none"></path>
                        <path id="chartLinePath" d="" fill="none" stroke="#135bec" stroke-width="2"></path>
                        <circle id="chartDot" class="animate-pulse" cx="0" cy="0" fill="#135bec" r="4" stroke="white"
                            stroke-width="2" style="display:none"></circle>
                    </svg>
                    <!-- Time labels -->
                    <div
                        class="absolute -bottom-5 w-full flex justify-between text-[8px] text-slate-400 font-mono px-1">
                        <span id="timeLabel1">--:--</span>
                        <span id="timeLabel2">--:--</span>
                        <span id="timeLabel3">--:--</span>
                        <span>Now</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="flex flex-col gap-4 lg:col-span-1">
            <!-- Water Level + Gauge cards -->
            <div class="grid grid-cols-2 lg:grid-cols-1 gap-4">
                <!-- Water Level Card -->
                <div
                    class="bg-white dark:bg-panel-dark rounded-xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm flex flex-col justify-center items-center relative overflow-hidden aspect-square">
                    <div class="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent pointer-events-none">
                    </div>
                    <h2 class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider mb-2">Water Level</h2>
                    <div class="flex items-baseline gap-0.5">
                        <span id="waterLevelValue"
                            class="text-5xl lg:text-6xl font-display font-bold text-slate-900 dark:text-white tracking-tighter">--</span>
                        <span class="text-sm font-medium text-slate-500">CM</span>
                    </div>
                    <div id="trendBadge"
                        class="mt-3 flex items-center gap-1 text-emerald-500 bg-emerald-500/10 px-2 py-1 rounded-full border border-emerald-500/20">
                        <span class="material-icons text-[10px]">check_circle</span>
                        <span class="text-[10px] font-bold">NORMAL</span>
                    </div>
                </div>

                <!-- Vertical Gauge Card -->
                <div
                    class="bg-white dark:bg-panel-dark rounded-xl border border-slate-200 dark:border-slate-800 p-3 shadow-sm flex items-center justify-center aspect-square">
                    <div class="w-full h-full flex gap-2">
                        <div
                            class="flex flex-col justify-between text-[10px] text-slate-400 font-mono text-right py-1 w-6">
                            <span>350</span><span>300</span><span>250</span><span>200</span><span>150</span><span>100</span><span>0</span>
                        </div>
                        <div
                            class="flex-1 bg-slate-100 dark:bg-slate-800 rounded-lg relative overflow-hidden border border-slate-200 dark:border-slate-700 shadow-inner w-8 mx-auto">
                            <div id="gaugeBarFill"
                                class="water-fill absolute bottom-0 w-full bg-gradient-to-t from-primary via-blue-400 to-yellow-400 transition-all duration-1000 ease-out"
                                style="height: 0%"></div>
                            <div class="absolute inset-0 flex flex-col justify-between py-1 px-1">
                                <div class="w-full border-b border-slate-900/10 dark:border-white/10 h-0"></div>
                                <div class="w-full border-b border-red-500/50 h-0 border-dashed relative">
                                    <span class="absolute right-0 top-[-8px] text-[8px] text-red-500">CRIT</span>
                                </div>
                                <div class="w-full border-b border-yellow-500/50 h-0 border-dashed relative">
                                    <span class="absolute right-0 top-[-8px] text-[8px] text-yellow-500">WARN</span>
                                </div>
                                <div class="w-full border-b border-slate-900/10 dark:border-white/10 h-0"></div>
                                <div class="w-full border-b border-slate-900/10 dark:border-white/10 h-0"></div>
                                <div class="w-full border-b border-slate-900/10 dark:border-white/10 h-0"></div>
                                <div class="w-full border-b border-slate-900/10 dark:border-white/10 h-0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Chart (Mobile) -->
            <div
                class="bg-white dark:bg-panel-dark rounded-xl border border-slate-200 dark:border-slate-800 p-4 shadow-sm lg:hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wide">History
                    </h3>
                    <div class="flex bg-slate-100 dark:bg-slate-900 rounded p-0.5">
                        <button onclick="setChartRange(60)"
                            class="chart-range-btn-m px-2 py-1 text-[10px] rounded text-slate-500 hover:text-primary dark:hover:text-white transition">1H</button>
                        <button onclick="setChartRange(360)"
                            class="chart-range-btn-m px-2 py-1 text-[10px] rounded bg-white dark:bg-primary text-primary dark:text-white shadow-sm font-medium active-range">6H</button>
                        <button onclick="setChartRange(1440)"
                            class="chart-range-btn-m px-2 py-1 text-[10px] rounded text-slate-500 hover:text-primary dark:hover:text-white transition">24H</button>
                    </div>
                </div>
                <div class="relative w-full aspect-video border-l border-b border-slate-200 dark:border-slate-700">
                    <div class="absolute w-full border-t border-dashed border-red-500/50 top-[20%] flex items-center">
                        <span class="text-[8px] text-red-500 ml-[-25px] absolute font-mono">290</span>
                    </div>
                    <div
                        class="absolute w-full border-t border-dashed border-yellow-500/50 top-[55%] flex items-center">
                        <span class="text-[8px] text-yellow-500 ml-[-25px] absolute font-mono">220</span>
                    </div>
                    <svg id="historyChartMobile" class="absolute inset-0 w-full h-full overflow-visible"
                        preserveAspectRatio="none" viewBox="0 0 1200 100">
                        <defs>
                            <linearGradient id="gradientAreaMobile" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="#135bec" stop-opacity="0.2"></stop>
                                <stop offset="100%" stop-color="#135bec" stop-opacity="0"></stop>
                            </linearGradient>
                        </defs>
                        <path id="chartAreaPathM" d="" fill="url(#gradientAreaMobile)" stroke="none"></path>
                        <path id="chartLinePathM" d="" fill="none" stroke="#135bec" stroke-width="3"></path>
                        <circle id="chartDotM" class="animate-pulse" cx="0" cy="0" fill="#135bec" r="6" stroke="white"
                            stroke-width="2" style="display:none"></circle>
                    </svg>
                    <div
                        class="absolute -bottom-5 w-full flex justify-between text-[8px] text-slate-400 font-mono px-1">
                        <span id="timeLabelM1">--:--</span>
                        <span id="timeLabelM2">--:--</span>
                        <span id="timeLabelM3">--:--</span>
                        <span>Now</span>
                    </div>
                </div>
            </div>

            <!-- Alert Panel -->
            <div id="alertPanel"
                class="bg-white dark:bg-panel-dark rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col overflow-hidden max-h-64 h-full">
                <div id="alertHeader"
                    class="p-3 border-b border-slate-200 dark:border-slate-800 bg-emerald-500/10 flex justify-between items-center sticky top-0 backdrop-blur-sm z-10">
                    <div>
                        <h3 id="alertTitle" class="text-xs font-bold text-emerald-600 dark:text-emerald-400">STATUS:
                            NORMAL</h3>
                    </div>
                    <div id="alertBell" class="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center">
                        <span class="material-icons text-white text-[10px]">check_circle</span>
                    </div>
                </div>
                <div id="alertLog" class="flex-1 overflow-y-auto p-3 space-y-2">
                    <div
                        class="flex gap-3 items-start p-2 rounded-lg bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800 opacity-60">
                        <div class="mt-0.5 text-emerald-500">
                            <span class="material-icons text-sm">check_circle</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-700 dark:text-slate-300">System started</p>
                            <p class="text-[10px] text-slate-500">Monitoring active</p>
                        </div>
                    </div>
                </div>
                <div class="p-2 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/30">
                    <button onclick="clearAlerts()"
                        class="w-full py-1 text-[10px] font-medium text-slate-500 hover:text-primary dark:hover:text-white transition-colors text-center">
                        Clear History</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer / Controls -->
    <footer
        class="fixed lg:static bottom-0 w-full bg-white dark:bg-panel-dark border-t border-slate-200 dark:border-slate-800 px-4 py-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] lg:shadow-none z-40 pb-safe lg:pb-3">
        <div class="flex flex-col gap-3 lg:flex-row lg:justify-between lg:items-center">
            <div
                class="flex justify-between items-center border-b border-slate-100 dark:border-slate-700/50 lg:border-none pb-2 lg:pb-0 lg:gap-6">
                <div class="flex gap-4">
                    <div id="chWeb" class="flex items-center gap-1 text-emerald-500">
                        <span class="material-icons text-[14px]">wifi</span>
                        <span class="text-[10px] font-bold">WEB</span>
                    </div>
                    <div id="chSms" class="flex items-center gap-1 text-slate-300 dark:text-slate-600">
                        <span class="material-icons text-[14px]">sms</span>
                        <span class="text-[10px]">SMS</span>
                    </div>
                    <div id="chBle" class="flex items-center gap-1 text-slate-300 dark:text-slate-600">
                        <span class="material-icons text-[14px]">bluetooth</span>
                        <span class="text-[10px]">BLE</span>
                    </div>
                    <div id="chChat" class="flex items-center gap-1 text-slate-300 dark:text-slate-600">
                        <span class="material-icons text-[14px]">lock</span>
                        <span class="text-[10px]">BRIAR</span>
                    </div>
                    <div id="chTelegram" class="flex items-center gap-1 text-slate-300 dark:text-slate-600">
                        <span class="material-icons text-[14px]">send</span>
                        <span class="text-[10px]">TG</span>
                    </div>
                </div>
                <div id="uptimeDisplay" class="text-[10px] text-slate-400 font-mono">
                    UP: --
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2 lg:flex lg:w-auto">
                <button onclick="openSettingsModal()"
                    class="flex flex-col lg:flex-row lg:gap-2 items-center justify-center p-2 lg:px-4 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 active:scale-95 transition-transform hover:bg-slate-100 dark:hover:bg-slate-700">
                    <span class="material-icons text-slate-500 text-lg mb-1 lg:mb-0">settings</span>
                    <span class="text-[10px] font-medium text-slate-600 dark:text-slate-300">Settings</span>
                </button>
                <button onclick="window.open('/api/config','_blank')"
                    class="flex flex-col lg:flex-row lg:gap-2 items-center justify-center p-2 lg:px-4 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 active:scale-95 transition-transform hover:bg-slate-100 dark:hover:bg-slate-700">
                    <span class="material-icons text-slate-500 text-lg mb-1 lg:mb-0">build</span>
                    <span class="text-[10px] font-medium text-slate-600 dark:text-slate-300">Calibrate</span>
                </button>
                <button onclick="testAlert()"
                    class="flex flex-col lg:flex-row lg:gap-2 items-center justify-center p-2 lg:px-4 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 active:scale-95 transition-transform hover:bg-slate-100 dark:hover:bg-slate-700">
                    <span class="material-icons text-slate-500 text-lg mb-1 lg:mb-0">science</span>
                    <span class="text-[10px] font-medium text-slate-600 dark:text-slate-300">Test Alert</span>
                </button>
                <button onclick="stopSystem()"
                    class="flex flex-col lg:flex-row lg:gap-2 items-center justify-center p-2 lg:px-4 rounded-lg bg-red-500 text-white shadow-md active:scale-95 transition-transform hover:bg-red-600">
                    <span class="material-icons text-lg mb-1 lg:mb-0">stop_circle</span>
                    <span class="text-[10px] font-bold">STOP SYS</span>
                </button>
            </div>
        </div>
    </footer>


    <!-- Settings Modal (Full Screen Dashboard) -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300 p-2 sm:p-6">
        <div id="settingsModalContent"
            class="bg-background-light dark:bg-[#0b0e14] border border-slate-200 dark:border-slate-800 rounded-2xl shadow-2xl w-full h-full max-w-7xl overflow-hidden transform scale-95 transition-transform duration-300 flex flex-col md:flex-row shadow-[0_0_50px_rgba(0,0,0,0.5)]">

            <!-- Sidebar -->
            <div
                class="w-64 flex-shrink-0 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-[#111318] flex flex-col justify-between hidden md:flex h-full">
                <div class="flex flex-col gap-4">
                    <div class="flex gap-3 items-center px-4 py-6 border-b border-slate-200 dark:border-slate-800">
                        <div
                            class="w-8 h-8 rounded bg-primary flex items-center justify-center shrink-0 shadow-[0_0_15px_rgba(19,91,236,0.5)]">
                            <span class="material-icons text-white text-sm">water_drop</span>
                        </div>
                        <div class="flex flex-col">
                            <h1 class="text-slate-900 dark:text-white text-base font-bold leading-none tracking-wide">
                                HYDRO<span class="text-primary">GUARD</span></h1>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-normal mt-1">Settings Dashboard
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 px-3 mt-2">
                        <button onclick="switchTab('system')" id="tab-btn-system"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary transition-colors text-left group">
                            <span class="material-icons text-[20px]">memory</span>
                            <span class="text-sm font-medium">System</span>
                        </button>
                        <button onclick="switchTab('camera')" id="tab-btn-camera"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-left group">
                            <span class="material-icons text-[20px]">videocam</span>
                            <span class="text-sm font-medium">Camera Calibration</span>
                        </button>
                        <button onclick="switchTab('alerts')" id="tab-btn-alerts"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-left group">
                            <span class="material-icons text-[20px]">warning</span>
                            <span class="text-sm font-medium">Alert Thresholds</span>
                        </button>
                        <button onclick="switchTab('sms')" id="tab-btn-sms"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-left group">
                            <span class="material-icons text-[20px]">sms</span>
                            <span class="text-sm font-medium">SMS Recipients</span>
                        </button>
                        <button onclick="switchTab('telegram')" id="tab-btn-telegram"
                            class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-left group">
                            <span class="material-icons text-[20px]">send</span>
                            <span class="text-sm font-medium">Telegram Bot</span>
                        </button>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                    <button onclick="closeSettingsModal()"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 font-medium transition-colors">
                        <span class="material-icons text-[18px]">close</span>
                        Close Settings
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50 dark:bg-[#0b0e14]">
                <!-- Mobile Header -->
                <div
                    class="md:hidden flex items-center justify-between p-4 bg-white dark:bg-[#111318] border-b border-slate-200 dark:border-slate-800 shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-primary flex items-center justify-center shrink-0">
                            <span class="material-icons text-white text-[10px]">water_drop</span>
                        </div>
                        <span class="font-bold text-lg dark:text-white leading-none tracking-tight">HYDRO<span
                                class="text-primary">GUARD</span></span>
                    </div>
                    <div class="flex gap-2">
                        <select id="mobileTabSelect" onchange="switchTab(this.value)"
                            class="bg-slate-100 dark:bg-slate-800 border-none text-xs rounded-lg py-1 pl-2 pr-6 text-slate-700 dark:text-slate-300 focus:ring-0">
                            <option value="system">System</option>
                            <option value="camera">Camera Calibration</option>
                            <option value="alerts">Alert Thresholds</option>
                            <option value="sms">SMS Recipients</option>
                            <option value="telegram">Telegram Bot</option>
                        </select>
                        <button onclick="closeSettingsModal()"
                            class="p-1.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                            <span class="material-icons text-[18px] block">close</span>
                        </button>
                    </div>
                </div>

                <!-- TAB: SYSTEM -->
                <div id="tab-system" class="settings-tab-panel flex-1 overflow-y-auto w-full h-full">
                    <div class="p-4 md:p-8 lg:p-10 max-w-5xl mx-auto">
                        <header class="mb-8">
                            <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white mb-2">System
                                Configuration</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">Monitor hardware performance and
                                configure core connection settings.</p>
                        </header>

                        <!-- Model Selection -->
                        <section
                            class="bg-white dark:bg-[#1a202c] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm mb-8">
                            <div
                                class="p-5 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-[#111318]/50">
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <span class="material-icons text-purple-500 text-[20px]">psychology</span> Detection
                                    Model
                                </h3>
                                <p class="text-xs text-slate-500 mt-1">Select which AI engine powers flood detection.
                                    Only one model is loaded at a time for energy efficiency.</p>
                            </div>
                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label id="modelCard-canny" onclick="selectModel('canny')"
                                    class="cursor-pointer rounded-xl border-2 border-primary bg-primary/5 p-5 flex gap-4 items-start transition-all hover:shadow-lg relative">
                                    <div
                                        class="absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-primary flex items-center justify-center">
                                        <div id="modelDot-canny" class="w-2.5 h-2.5 rounded-full bg-primary"></div>
                                    </div>
                                    <span class="material-icons text-primary text-3xl mt-0.5">auto_graph</span>
                                    <div>
                                        <h4 class="font-bold text-slate-900 dark:text-white text-sm">Canny/Hough Edge
                                            Detection</h4>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Lightweight CV
                                            pipeline. Detects water surface using edge detection + HoughLinesP. Requires
                                            ROI calibration.</p>
                                        <div class="flex gap-2 mt-2">
                                            <span
                                                class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 font-semibold">LOW
                                                CPU</span>
                                            <span
                                                class="text-[10px] px-2 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-semibold">NEEDS
                                                ROI</span>
                                        </div>
                                    </div>
                                </label>
                                <label id="modelCard-stable" onclick="selectModel('stable')"
                                    class="cursor-pointer rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-transparent p-5 flex gap-4 items-start transition-all hover:shadow-lg relative">
                                    <div
                                        class="absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center">
                                        <div id="modelDot-stable" class="w-2.5 h-2.5 rounded-full bg-transparent"></div>
                                    </div>
                                    <span class="material-icons text-emerald-500 text-3xl mt-0.5">calculate</span>
                                    <div>
                                        <h4 class="font-bold text-slate-900 dark:text-white text-sm">Stable Horizontal
                                            Math</h4>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Robust 1D convolution
                                            and moving Median temporal filtering projection. Zero hallucination.</p>
                                        <div class="flex gap-2 mt-2">
                                            <span
                                                class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 font-semibold">FAST
                                                CPU</span>
                                            <span
                                                class="text-[10px] px-2 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-semibold">NEEDS
                                                ROI</span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </section>
                        <div
                            class="p-5 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-[#111318]/50">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                <span class="material-icons text-orange-500 text-[20px]">hub</span> YOLO
                                Configuration
                            </h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex flex-col gap-4">
                                <label class="flex flex-col gap-1.5">
                                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Reference
                                        Line Start (x, y)</span>
                                    <div class="flex gap-2">
                                        <input id="cfgYoloLineStartX"
                                            class="flex-1 rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 text-sm font-mono"
                                            type="number" value="1094" placeholder="X" />
                                        <input id="cfgYoloLineStartY"
                                            class="flex-1 rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 text-sm font-mono"
                                            type="number" value="231" placeholder="Y" />
                                    </div>
                                </label>
                                <label class="flex flex-col gap-1.5">
                                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Reference
                                        Line End (x, y)</span>
                                    <div class="flex gap-2">
                                        <input id="cfgYoloLineEndX"
                                            class="flex-1 rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 text-sm font-mono"
                                            type="number" value="1083" placeholder="X" />
                                        <input id="cfgYoloLineEndY"
                                            class="flex-1 rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 text-sm font-mono"
                                            type="number" value="403" placeholder="Y" />
                                    </div>
                                </label>
                            </div>
                            <div class="flex flex-col gap-4">
                                <label class="flex flex-col gap-1.5">
                                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Pixels per
                                        Meter</span>
                                    <input id="cfgYoloPxPerMeter"
                                        class="rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 text-sm font-mono"
                                        type="number" value="15" />
                                </label>
                                <label class="flex flex-col gap-1.5">
                                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Tip Height
                                        (meters)</span>
                                    <input id="cfgYoloTipHeight"
                                        class="rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 text-sm font-mono"
                                        type="number" step="0.1" value="15" />
                                </label>
                                <label class="flex flex-col gap-1.5">
                                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Minimum
                                        Confidence (%)</span>
                                    <input id="cfgYoloConfidence"
                                        class="rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 text-sm font-mono"
                                        type="number" step="1" min="1" max="100" value="50" />
                                </label>
                            </div>
                        </div>
                        <div class="px-6 pb-6 flex justify-end">
                            <button onclick="saveYoloSettings()"
                                class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-orange-500/20 flex items-center gap-2">
                                <span class="material-icons text-[18px]">save</span> Save YOLO Settings
                            </button>
                        </div>
                        </section>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <section
                                class="bg-white dark:bg-[#1a202c] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
                                <div
                                    class="p-5 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-[#111318]/50">
                                    <h3
                                        class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <span class="material-icons text-primary text-[20px]">videocam</span> DroidCam
                                        Connection
                                    </h3>
                                </div>
                                <div class="p-6 flex flex-col gap-5">
                                    <div class="flex flex-col gap-4">
                                        <label class="flex flex-col gap-1.5">
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Device
                                                IP Address & Port</span>
                                            <div class="flex gap-2">
                                                <div class="relative flex-1">
                                                    <span
                                                        class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-500">
                                                        <span class="material-icons text-[18px]">lan</span>
                                                    </span>
                                                    <input id="cfgDroidCamIp"
                                                        class="w-full rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 pl-10 pr-4 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary placeholder-slate-400 text-sm font-mono"
                                                        type="text" value="192.168.1.175" />
                                                </div>
                                                <div class="relative w-24">
                                                    <input id="cfgDroidCamPort"
                                                        class="w-full rounded-lg bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white py-2.5 px-3 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary text-sm font-mono text-center"
                                                        type="text" value="4747" />
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    <div
                                        class="rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/30 p-3 flex gap-3 items-start">
                                        <span class="material-icons text-blue-600 dark:text-blue-400 mt-0.5">info</span>
                                        <div>
                                            <h4 class="text-sm font-semibold text-blue-900 dark:text-blue-100">Video
                                                Source URL</h4>
                                            <p
                                                class="text-[10px] text-blue-700 dark:text-blue-300 mt-1 font-mono break-all">
                                                http://<span id="previewIp">192.168.1.175</span>:<span
                                                    id="previewPort">4747</span>/video</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end pt-2">
                                        <button onclick="saveCameraSettings()"
                                            class="bg-primary hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-primary/20 flex items-center gap-2">
                                            <span class="material-icons text-[18px]">save</span> Save Camera Settings
                                        </button>
                                    </div>
                                </div>
                            </section>

                            <section
                                class="bg-white dark:bg-[#1a202c] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm h-fit">
                                <div
                                    class="p-5 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-[#111318]/50">
                                    <h3
                                        class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <span class="material-icons text-emerald-500 text-[20px]">monitor_heart</span>
                                        System Diagnostics
                                    </h3>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div
                                            class="bg-slate-50 dark:bg-[#111318] p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                                            <p
                                                class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-1">
                                                Status</p>
                                            <p class="text-lg font-bold text-emerald-500 flex items-center gap-1">
                                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                                Active
                                            </p>
                                        </div>
                                        <div
                                            class="bg-slate-50 dark:bg-[#111318] p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                                            <p
                                                class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-1">
                                                Engine</p>
                                            <p class="text-lg font-bold text-slate-900 dark:text-white">Running</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- TAB: CAMERA CALIBRATION -->
                <div id="tab-camera" class="settings-tab-panel flex-1 flex flex-col hidden h-full w-full">
                    <header
                        class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-[#111318] shrink-0">
                        <div>
                            <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white">Calibration Mode
                            </h1>
                            <p class="text-xs text-slate-500 dark:text-[#9da6b9]">Adjust threshold lines to configure
                                alert levels.</p>
                        </div>
                    </header>
                    <div class="flex flex-col lg:flex-row flex-1 overflow-hidden min-h-0">
                        <div
                            class="flex-1 p-0 md:p-4 bg-slate-900 relative flex items-center justify-center min-h-[40vh] lg:min-h-0 overflow-hidden">
                            <!-- Video Container uses w-full to fill available space but respects aspect ratio -->
                            <div
                                class="relative w-full h-full max-h-full aspect-video bg-black md:rounded-lg overflow-hidden shadow-2xl ring-1 ring-slate-800 flex items-center justify-center">

                                <img id="calibVideoFeed" src="/video_feed"
                                    class="absolute inset-0 w-full h-full object-contain opacity-60 pointer-events-none" />

                                <div
                                    class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent pointer-events-none">
                                </div>

                                <div
                                    class="absolute top-3 left-3 bg-black/80 backdrop-blur text-white px-2 py-1 rounded text-[10px] font-mono border border-white/20 pointer-events-none z-10">
                                    LIVE PREVIEW DEMO
                                </div>

                                <!-- Decorative lines (z-10, under canvas) -->
                                <div class="absolute w-full flex items-center border-t border-dashed border-red-500/50 pointer-events-none z-10"
                                    style="top: 20%;">
                                    <div
                                        class="absolute right-2 -top-3 bg-red-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded">
                                        CRITICAL</div>
                                </div>
                                <div class="absolute w-full flex items-center border-t border-dashed border-orange-500/50 pointer-events-none z-10"
                                    style="top: 35%;">
                                    <div
                                        class="absolute right-2 -top-3 bg-orange-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded">
                                        DANGER</div>
                                </div>
                                <div class="absolute w-full flex items-center border-t border-dashed border-yellow-500/50 pointer-events-none z-10"
                                    style="top: 55%;">
                                    <div
                                        class="absolute right-2 -top-3 bg-yellow-600 text-black text-[8px] font-bold px-1.5 py-0.5 rounded">
                                        WARNING</div>
                                </div>

                                <!-- Instruction Overlay (z-10, under canvas) -->
                                <div id="roiInstruction"
                                    class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/60 backdrop-blur text-white/80 px-4 py-1.5 rounded-full text-xs pointer-events-none flex items-center gap-2 border border-white/10 z-10 transition-all">
                                    <span class="material-icons text-[14px] text-primary">touch_app</span>
                                    Click <b>TOP-LEFT</b> corner of the ROI
                                </div>

                                <!-- Interactive ROI Canvas MUST BE HIGHEST Z-INDEX (z-50) so it is always clickable -->
                                <canvas id="roiCanvas"
                                    class="absolute inset-0 w-full h-full object-contain cursor-crosshair z-50 pointer-events-auto"
                                    title="Click and drag to draw Water ROI"></canvas>
                            </div>
                        </div>
                        <div
                            class="w-full lg:w-[350px] xl:w-[400px] shrink-0 bg-white dark:bg-[#111318] border-t lg:border-t-0 lg:border-l border-slate-200 dark:border-slate-800 flex flex-col h-[45vh] lg:h-full overflow-y-auto">
                            <div class="p-5 flex-1">
                                <h2
                                    class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-4 flex items-center justify-between">
                                    Threshold Values
                                    <span class="bg-primary/10 text-primary px-2 py-0.5 rounded text-[10px]">CM</span>
                                </h2>
                                <div class="flex flex-col gap-4">
                                    <div class="group">
                                        <label class="flex justify-between text-xs font-medium mb-1.5"><span
                                                class="flex items-center gap-2"><span
                                                    class="w-2 h-2 rounded-full bg-red-500"></span>
                                                Critical</span></label>
                                        <input id="cfgCrit"
                                            class="w-full bg-slate-50 dark:bg-[#1c1f27] border border-slate-200 dark:border-[#3b4354] rounded-lg px-3 py-2 text-slate-900 dark:text-white font-mono text-sm focus:ring-1 focus:ring-red-500 focus:border-red-500 outline-none"
                                            type="number" value="290" />
                                    </div>
                                    <div class="group">
                                        <label class="flex justify-between text-xs font-medium mb-1.5"><span
                                                class="flex items-center gap-2"><span
                                                    class="w-2 h-2 rounded-full bg-orange-500"></span>
                                                Danger</span></label>
                                        <input id="cfgDang"
                                            class="w-full bg-slate-50 dark:bg-[#1c1f27] border border-slate-200 dark:border-[#3b4354] rounded-lg px-3 py-2 text-slate-900 dark:text-white font-mono text-sm focus:ring-1 focus:ring-orange-500 focus:border-orange-500 outline-none"
                                            type="number" value="260" />
                                    </div>
                                    <div class="group">
                                        <label class="flex justify-between text-xs font-medium mb-1.5"><span
                                                class="flex items-center gap-2"><span
                                                    class="w-2 h-2 rounded-full bg-yellow-500"></span>
                                                Warning</span></label>
                                        <input id="cfgWarn"
                                            class="w-full bg-slate-50 dark:bg-[#1c1f27] border border-slate-200 dark:border-[#3b4354] rounded-lg px-3 py-2 text-slate-900 dark:text-white font-mono text-sm focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500 outline-none"
                                            type="number" value="220" />
                                    </div>
                                </div>
                            </div>
                            <!-- NEW MANUAL ROI SECTION -->
                            <div class="p-5 border-t border-slate-200 dark:border-slate-800 shrink-0">
                                <h2 class="text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-3">Manual
                                    ROI
                                    (Pixels)</h2>
                                <div class="grid grid-cols-2 gap-3">
                                    <label
                                        class="flex justify-between items-center text-[10px] font-medium text-slate-500">Top
                                        Y:
                                        <input id="cfgRoiY1" type="number"
                                            class="w-16 bg-slate-50 dark:bg-[#1c1f27] border border-slate-200 dark:border-[#3b4354] rounded px-2 py-1 text-slate-900 dark:text-white font-mono outline-none"
                                            placeholder="auto">
                                    </label>
                                    <label
                                        class="flex justify-between items-center text-[10px] font-medium text-slate-500">Bot
                                        Y:
                                        <input id="cfgRoiY2" type="number"
                                            class="w-16 bg-slate-50 dark:bg-[#1c1f27] border border-slate-200 dark:border-[#3b4354] rounded px-2 py-1 text-slate-900 dark:text-white font-mono outline-none"
                                            placeholder="auto">
                                    </label>
                                    <label
                                        class="flex justify-between items-center text-[10px] font-medium text-slate-500">Left
                                        X:
                                        <input id="cfgRoiX1" type="number"
                                            class="w-16 bg-slate-50 dark:bg-[#1c1f27] border border-slate-200 dark:border-[#3b4354] rounded px-2 py-1 text-slate-900 dark:text-white font-mono outline-none"
                                            placeholder="auto">
                                    </label>
                                    <label
                                        class="flex justify-between items-center text-[10px] font-medium text-slate-500">Right
                                        X:
                                        <input id="cfgRoiX2" type="number"
                                            class="w-16 bg-slate-50 dark:bg-[#1c1f27] border border-slate-200 dark:border-[#3b4354] rounded px-2 py-1 text-slate-900 dark:text-white font-mono outline-none"
                                            placeholder="auto">
                                    </label>
                                </div>
                            </div>
                            <div
                                class="p-4 bg-slate-50 dark:bg-[#0b0e14] border-t border-slate-200 dark:border-slate-800 shrink-0 sticky bottom-0 z-20">
                                <button onclick="saveLevels()"
                                    class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white font-bold py-2.5 px-4 rounded-lg transition-all shadow shadow-primary/20 text-sm">
                                    <span class="material-icons text-[16px]">save</span> Save Calibration
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ALERTS -->
            <div id="tab-alerts" class="settings-tab-panel flex-1 overflow-y-auto hidden w-full h-full">
                <div class="p-4 md:p-8 lg:p-10 max-w-4xl mx-auto">
                    <header class="mb-8">
                        <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white mb-2">
                            Notification Rules</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Determine which channels are used for
                            each alert level.</p>
                    </header>
                    <div
                        class="bg-white dark:bg-[#1a202c] border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden shadow-sm">
                        <div
                            class="grid grid-cols-12 gap-2 p-4 border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-[#111318] text-xs uppercase font-bold text-slate-500 tracking-wider">
                            <div class="col-span-6 md:col-span-8 pl-2">Trigger Event</div>
                            <div class="col-span-6 md:col-span-4 text-center">SMS Delivery</div>
                        </div>

                        <div
                            class="grid grid-cols-12 gap-2 p-4 border-b border-slate-200 dark:border-slate-800 items-center hover:bg-slate-50/50 dark:hover:bg-[#111318]/50 transition-colors">
                            <div class="col-span-6 md:col-span-8 flex items-center gap-3 pl-2">
                                <span class="material-icons text-yellow-500">warning</span>
                                <div>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">Warning Reached</p>
                                    <p class="text-[10px] text-slate-500">Crosses yellow line</p>
                                </div>
                            </div>
                            <div class="col-span-6 md:col-span-4 flex justify-center">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifyWarnSMS" class="sr-only peer" checked>
                                    <div
                                        class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div
                            class="grid grid-cols-12 gap-2 p-4 border-b border-slate-200 dark:border-slate-800 items-center hover:bg-slate-50/50 dark:hover:bg-[#111318]/50 transition-colors">
                            <div class="col-span-6 md:col-span-8 flex items-center gap-3 pl-2">
                                <span class="material-icons text-orange-500">error</span>
                                <div>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">Danger Reached</p>
                                    <p class="text-[10px] text-slate-500">Crosses orange line</p>
                                </div>
                            </div>
                            <div class="col-span-6 md:col-span-4 flex justify-center">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifyDangSMS" class="sr-only peer" checked>
                                    <div
                                        class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div
                            class="grid grid-cols-12 gap-2 p-4 items-center bg-red-50/50 dark:bg-red-900/10 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <div class="col-span-6 md:col-span-8 flex items-center gap-3 pl-2">
                                <span class="material-icons text-red-500">notifications_active</span>
                                <div>
                                    <p class="text-sm font-bold text-red-600 dark:text-red-400">Critical Reached</p>
                                    <p class="text-[10px] text-red-500/70">Crosses red line</p>
                                </div>
                            </div>
                            <div class="col-span-6 md:col-span-4 flex justify-center">
                                <label class="relative inline-flex items-center cursor-not-allowed opacity-60">
                                    <input type="checkbox" class="sr-only peer" checked disabled>
                                    <div
                                        class="w-9 h-5 bg-red-500 rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4">
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Audible Siren Toggle -->
                        <div
                            class="grid grid-cols-12 gap-2 p-4 items-center hover:bg-slate-50/50 dark:hover:bg-[#111318]/50 transition-colors border-t border-slate-200 dark:border-slate-800">
                            <div class="col-span-6 md:col-span-8 flex items-center gap-3 pl-2">
                                <span class="material-icons text-primary">volume_up</span>
                                <div>
                                    <p class="text-sm font-bold text-slate-900 dark:text-white">Audible Buzzer</p>
                                    <p class="text-[10px] text-slate-500">Play sound during alerts</p>
                                </div>
                            </div>
                            <div class="col-span-6 md:col-span-4 flex justify-center">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="cfgSirenEnabled" class="sr-only peer"
                                        onchange="siren.setEnabled(this.checked)">

                                    <div
                                        class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary dark:bg-slate-700 dark:border-slate-600">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-3 pl-1 font-medium"><span class="text-red-500">*</span>
                        Critical alerts are mandatory and forced to send SMS.</p>
                    <div class="mt-6 flex justify-end">
                        <button onclick="saveNotificationRules()"
                            class="bg-primary hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-primary/20 flex items-center gap-2">
                            <span class="material-icons text-[18px]">save</span> Save Rules
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB: SMS RECIPIENTS -->
            <div id="tab-sms" class="settings-tab-panel flex-1 overflow-y-auto hidden w-full h-full">
                <div class="p-4 md:p-8 lg:p-10 max-w-4xl mx-auto flex flex-col gap-6">
                    <header>
                        <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white mb-2">SMS
                            Integration</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Manage who receives alerts via the KDE
                            Connect bridge.</p>
                    </header>

                    <div
                        class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a202c] p-6 shadow-sm">
                        <div class="flex items-start md:items-center gap-4 mb-6">
                            <div
                                class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 shrink-0">
                                <span class="material-icons block">smartphone</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white">KDE Connect Device
                                    Binding</h3>
                                <p class="text-xs text-slate-500 mt-0.5">Device ID required for routing messages
                                    from host to phone.</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-slate-700 dark:text-slate-300">Device ID /
                                Name</label>
                            <div class="relative">
                                <input id="cfgDeviceId"
                                    class="w-full bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-1 focus:ring-primary focus:border-primary block p-2.5 font-mono"
                                    type="text" placeholder="e.g. Y18">
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1 flex items-center gap-1"><span
                                    class="material-icons text-[12px]">lightbulb</span> Run <code
                                    class="bg-slate-100 dark:bg-slate-800 px-1 rounded font-mono text-slate-700 dark:text-slate-300 border border-slate-200 dark:border-slate-700">kdeconnect-cli -l</code>
                                on the host machine to list paired devices.</p>
                        </div>
                    </div>

                    <div
                        class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1a202c] overflow-hidden shadow-sm flex flex-col">
                        <div
                            class="p-5 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-[#111318]/50 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Active Recipients</h3>
                            <span
                                class="bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border border-emerald-500/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">Comma
                                Separated</span>
                        </div>
                        <div class="p-6">
                            <textarea id="cfgRecipients" rows="4"
                                class="w-full bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary placeholder-slate-400 font-mono shadow-inner"
                                placeholder="+639123456789, +639987654321"></textarea>
                            <p class="text-[10px] text-slate-500 mt-2">Enter phone numbers with country code
                                separated by commas.</p>

                            <div class="mt-6 flex justify-end">
                                <button onclick="saveSmsSettings()"
                                    class="bg-primary hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-primary/20 flex items-center gap-2">
                                    <span class="material-icons text-[18px]">save</span> Save SMS Providers
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: TELEGRAM -->
                <div id="tab-telegram" class="settings-tab-panel flex-1 overflow-y-auto w-full h-full hidden">
                    <div class="p-4 md:p-8 lg:p-10 max-w-5xl mx-auto">
                        <header class="mb-8">
                            <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white mb-2">Telegram
                                Integration</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">Configure your Telegram Bot for
                                instant, high-priority notifications.</p>
                        </header>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <section
                                class="bg-white dark:bg-[#1a202c] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
                                <div
                                    class="p-5 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-[#111318]/50">
                                    <h3
                                        class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <span class="material-icons text-blue-500 text-[20px]">smart_toy</span> Bot
                                        Configuration
                                    </h3>
                                </div>
                                <div class="p-6 flex flex-col gap-6">
                                    <div class="flex flex-col gap-1.5">
                                        <label class="text-xs font-bold text-slate-700 dark:text-slate-300">Bot API
                                            Token</label>
                                        <input id="cfgTgToken" type="password"
                                            class="w-full bg-slate-50 dark:bg-[#111318] border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white text-sm rounded-lg p-2.5 font-mono"
                                            placeholder="123456789:ABCDefGhIjKlMnOpQrStUvWxYz">
                                        <p class="text-[10px] text-slate-500 mt-1 italic">Obtain this from @BotFather on
                                            Telegram.</p>
                                    </div>
                                    <div class="flex flex-col gap-1.5">
                                        <label class="text-xs font-bold text-slate-700 dark:text-slate-300">Current Chat
                                            ID</label>
                                        <div class="flex gap-2">
                                            <input id="cfgTgChatId" type="text" readonly
                                                class="flex-1 bg-slate-100 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-800 text-slate-500 text-sm rounded-lg p-2.5 font-mono cursor-not-allowed"
                                                placeholder="Waiting for registration...">
                                            <div id="tgStatusBadge"
                                                class="px-2 py-0.5 rounded flex items-center justify-center bg-slate-100 text-slate-400 text-[10px] font-bold">
                                                INACTIVE</div>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button onclick="saveTgSettings()"
                                            class="bg-primary hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-primary/20 flex items-center gap-2">
                                            <span class="material-icons text-[18px]">save</span> Update Token
                                        </button>
                                    </div>
                                </div>
                            </section>

                            <section
                                class="bg-white dark:bg-[#1a202c] rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm h-fit">
                                <div
                                    class="p-5 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-[#111318]/50">
                                    <h3
                                        class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <span
                                            class="material-icons text-emerald-500 text-[20px]">app_registration</span>
                                        Registration Guide
                                    </h3>
                                </div>
                                <div class="p-6">
                                    <ol class="space-y-4 text-xs text-slate-600 dark:text-slate-400 list-decimal pl-4">
                                        <li>Message your bot on Telegram.</li>
                                        <li>Send the command <code
                                                class="bg-primary/10 text-primary px-1.5 py-0.5 rounded font-mono font-bold">/register</code>.
                                        </li>
                                        <li>The system will automatically detect your Chat ID.</li>
                                        <li>You will receive a confirmation message.</li>
                                    </ol>
                                    <div
                                        class="mt-6 p-4 rounded-lg bg-emerald-500/5 border border-emerald-500/20 flex gap-3 items-start">
                                        <span class="material-icons text-emerald-500">info</span>
                                        <p class="text-[11px] leading-relaxed text-emerald-700 dark:text-emerald-400">
                                            <b>Auto-Registration:</b> You don't need to manually enter the Chat ID. Just
                                            send /register to your bot and this screen will update automatically.
                                        </p>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer" class="fixed top-16 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        // ======== HYDROGUARD Dashboard â€” Live data wiring ========

        const socket = io();

        // ---- State ----
        let chartData = [];
        let currentLevel = 0;

        // Buzzer Manager (Web Audio API)
        class BuzzerManager {
            constructor() {
                this.ctx = null;
                this.osc = null;
                this.gain = null;
                this.active = false;
                this.enabled = localStorage.getItem('sirenEnabled') !== 'false'; // Default to true

            }

            start() {
                if (!this.enabled || this.active) return;

                try {
                    if (!this.ctx) {
                        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (this.ctx.state === 'suspended') {
                        this.ctx.resume();
                    }

                    this.osc = this.ctx.createOscillator();
                    this.gain = this.ctx.createGain();

                    // Beep effect for buzzer
                    this.osc.type = 'square';
                    this.osc.frequency.setValueAtTime(880, this.ctx.currentTime); // Higher pitch for buzzer

                    // Rapid beep for Critical/Danger
                    const beepRate = currentLevel >= 3 ? 0.2 : 0.5;
                    this.lfo = this.ctx.createOscillator();
                    this.lfoGain = this.ctx.createGain();
                    this.lfo.type = 'square';
                    this.lfo.frequency.value = 2.0; // 2Hz beep

                    this.gain.gain.setValueAtTime(0, this.ctx.currentTime);

                    // Connect LFO to Gain for beeping
                    this.lfo.connect(this.lfoGain);
                    this.lfoGain.connect(this.gain.gain);
                    this.lfoGain.gain.value = 0.3;

                    this.osc.connect(this.gain);
                    this.gain.connect(this.ctx.destination);

                    this.osc.connect(this.gain);
                    this.gain.connect(this.ctx.destination);

                    this.osc.start();
                    this.lfo.start();
                    this.active = true;
                } catch (e) {
                    console.error("Audio error:", e);
                }
            }

            stop() {
                if (!this.active) return;
                try {
                    const now = this.ctx.currentTime;
                    this.gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    setTimeout(() => {
                        if (this.osc) {
                            this.osc.stop();
                            this.lfo.stop();
                            this.osc.disconnect();
                            this.lfo.disconnect();
                        }
                        this.active = false;
                    }, 600);
                } catch (e) {
                    this.active = false;
                }
            }

            setEnabled(val) {
                this.enabled = val;
                localStorage.setItem('sirenEnabled', val);
                if (!val) this.stop();
                else if (currentLevel >= 1) this.start();

                // Resume context on user interaction
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }
        }
        const siren = new BuzzerManager();


        // Resume AudioContext on first interaction
        document.addEventListener('click', () => {
            if (siren.ctx && siren.ctx.state === 'suspended') {
                siren.ctx.resume();
            }
        }, { once: true });

        let chartRange = 360; // minutes
        const ALERT_COLORS = {
            0: { name: 'NORMAL', color: 'emerald', icon: 'check_circle' },
            1: { name: 'WARNING', color: 'yellow', icon: 'warning' },
            2: { name: 'DANGER', color: 'orange', icon: 'error' },
            3: { name: 'CRITICAL', color: 'red', icon: 'notifications_active' },
        };

        // ---- Elements ----
        const $ = id => document.getElementById(id);

        // ---- Clock ----
        setInterval(() => {
            const now = new Date();
            $('clockDisplay').textContent = now.toLocaleTimeString('en-US', { hour12: false }) + ' UTC';
        }, 1000);

        // ---- Socket.IO Events ----
        socket.on('connect', () => {
            $('statusText').textContent = 'Online';
            $('statusDot').className = 'w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse';
        });

        socket.on('disconnect', () => {
            $('statusText').textContent = 'Offline';
            $('statusDot').className = 'w-1.5 h-1.5 rounded-full bg-red-500';
        });

        socket.on('water_level', (data) => {
            updateWaterLevel(data);
        });

        socket.on('alert', (data) => {
            addAlertEntry(data);
            showToast(data);

            // Sync current level from alert
            const levelMap = { 'NORMAL': 0, 'WARNING': 1, 'DANGER': 2, 'CRITICAL': 3 };
            const level = levelMap[data.new_level] !== undefined ? levelMap[data.new_level] : 0;

            if (level !== currentLevel) {
                currentLevel = level;
                updateTrendBadge(level);
                updateAlertPanel(level);

                if (level >= 1) {
                    siren.start();
                } else {
                    siren.stop();
                }
            }
        });

        // ---- Update Water Level ----
        function updateWaterLevel(data) {
            const cm = data.water_level_cm;
            const conf = data.confidence || 0;
            const level = data.alert_level || 0;

            if (cm !== null && cm !== undefined) {
                // Big number
                $('waterLevelValue').textContent = Math.round(cm);

                // Gauge fill (0-350 range)
                const pct = Math.max(0, Math.min(100, (cm / 350) * 100));
                $('gaugeBarFill').style.height = pct + '%';

                // Change gauge gradient color based on level
                if (level >= 3) {
                    $('gaugeBarFill').className = 'water-fill absolute bottom-0 w-full bg-gradient-to-t from-red-600 via-red-400 to-red-300 transition-all duration-1000 ease-out';
                } else if (level >= 2) {
                    $('gaugeBarFill').className = 'water-fill absolute bottom-0 w-full bg-gradient-to-t from-orange-600 via-orange-400 to-yellow-400 transition-all duration-1000 ease-out';
                } else if (level >= 1) {
                    $('gaugeBarFill').className = 'water-fill absolute bottom-0 w-full bg-gradient-to-t from-primary via-blue-400 to-yellow-400 transition-all duration-1000 ease-out';
                } else {
                    $('gaugeBarFill').className = 'water-fill absolute bottom-0 w-full bg-gradient-to-t from-primary via-blue-400 to-emerald-400 transition-all duration-1000 ease-out';
                }

                // Confidence
                $('confBadge').textContent = 'CONF: ' + Math.round(conf * 100) + '%';

                // Trend badge
                updateTrendBadge(level);

                // Add to chart
                chartData.push({ ts: data.timestamp, cm: cm });
                if (chartData.length > 1000) chartData = chartData.slice(-1000);
                renderChart();
            }

            // Update alert level
            if (level !== currentLevel) {
                currentLevel = level;
                updateAlertPanel(level);

                // Sound logic (Warning, Danger, Critical)
                if (level >= 1) {
                    siren.start();
                } else {
                    siren.stop();
                }
            }
        }

        function updateTrendBadge(level) {
            const badge = $('trendBadge');
            const info = ALERT_COLORS[level];
            const colorMap = {
                'emerald': { text: 'text-emerald-500', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' },
                'yellow': { text: 'text-yellow-500', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20' },
                'orange': { text: 'text-orange-500', bg: 'bg-orange-500/10', border: 'border-orange-500/20' },
                'red': { text: 'text-red-500', bg: 'bg-red-500/10', border: 'border-red-500/20' },
            };
            const c = colorMap[info.color];
            badge.className = `mt-3 flex items-center gap-1 ${c.text} ${c.bg} px-2 py-1 rounded-full border ${c.border}`;
            badge.innerHTML = `<span class="material-icons text-[10px]">${info.icon}</span><span class="text-[10px] font-bold">${info.name}</span>`;
        }

        function updateAlertPanel(level) {
            const info = ALERT_COLORS[level];
            const header = $('alertHeader');
            const title = $('alertTitle');
            const bell = $('alertBell');

            const colorCls = {
                'emerald': { headerBg: 'bg-emerald-500/10', titleText: 'text-emerald-600 dark:text-emerald-400', bellBg: 'bg-emerald-500' },
                'yellow': { headerBg: 'bg-yellow-500/10', titleText: 'text-yellow-600 dark:text-yellow-400', bellBg: 'bg-yellow-500' },
                'orange': { headerBg: 'bg-orange-500/10', titleText: 'text-orange-600 dark:text-orange-400', bellBg: 'bg-orange-500' },
                'red': { headerBg: 'bg-red-500/10', titleText: 'text-red-600 dark:text-red-400', bellBg: 'bg-red-500' },
            };
            const c = colorCls[info.color];

            header.className = `p-3 border-b border-slate-200 dark:border-slate-800 ${c.headerBg} flex justify-between items-center sticky top-0 backdrop-blur-sm z-10`;
            title.className = `text-xs font-bold ${c.titleText}`;
            title.textContent = `ALERT: ${info.name}`;
            bell.className = `w-6 h-6 rounded-full ${c.bellBg} flex items-center justify-center` + (level >= 2 ? ' animate-pulse' : '');
            bell.innerHTML = `<span class="material-icons text-white text-[10px]">${info.icon}</span>`;
        }

        // ---- Alert Log ----
        function addAlertEntry(data) {
            const log = $('alertLog');
            const time = new Date(data.timestamp * 1000);
            const timeStr = time.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            const levelName = (data.new_level || 'INFO').toLowerCase();

            const iconMap = {
                'warning': { icon: 'warning', color: 'text-yellow-500' },
                'danger': { icon: 'error', color: 'text-orange-500' },
                'critical': { icon: 'notifications_active', color: 'text-red-500' },
                'normal': { icon: 'check_circle', color: 'text-emerald-500' },
            };
            const ic = iconMap[levelName] || iconMap['normal'];

            const entry = document.createElement('div');
            entry.className = 'flex gap-3 items-start p-2 rounded-lg bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800';
            entry.innerHTML = `
            <div class="mt-0.5 ${ic.color}"><span class="material-icons text-sm">${ic.icon}</span></div>
            <div>
                <p class="text-xs font-bold text-slate-700 dark:text-slate-300">${data.message || data.new_level || 'Alert'}</p>
                <p class="text-[10px] text-slate-500">${timeStr} â€¢ Water at ${data.water_level_cm || '--'} cm</p>
            </div>
        `;

            log.insertBefore(entry, log.firstChild);
            while (log.children.length > 20) log.removeChild(log.lastChild);
        }

        function clearAlerts() {
            $('alertLog').innerHTML = '';
        }

        // ---- SVG Chart ----
        function renderChart() {
            const now = Date.now() / 1000;
            const rangeSeconds = chartRange * 60;
            const filtered = chartData.filter(p => (now - p.ts) <= rangeSeconds);

            if (filtered.length < 2) return;

            const minCm = 0, maxCm = 350;
            const w = 1200, h = 100;

            let linePts = [];
            let areaPts = [];

            filtered.forEach((p, i) => {
                const x = ((p.ts - filtered[0].ts) / (filtered[filtered.length - 1].ts - filtered[0].ts)) * w;
                const y = h - ((p.cm - minCm) / (maxCm - minCm)) * h;
                linePts.push(`${i === 0 ? 'M' : 'L'}${x.toFixed(1)},${y.toFixed(1)}`);
                areaPts.push(`${x.toFixed(1)},${y.toFixed(1)}`);
            });

            const lineD = linePts.join(' ');
            const areaD = `M${areaPts[0]} ${linePts.slice(1).join(' ')} L${w},${h} L0,${h} Z`;

            // Desktop chart
            $('chartLinePath').setAttribute('d', lineD);
            $('chartAreaPath').setAttribute('d', areaD);
            const lastPt = filtered[filtered.length - 1];
            const lastX = w;
            const lastY = h - ((lastPt.cm - minCm) / (maxCm - minCm)) * h;
            $('chartDot').setAttribute('cx', lastX);
            $('chartDot').setAttribute('cy', lastY);
            $('chartDot').style.display = '';

            // Mobile chart (duplicate)
            const mLine = document.getElementById('chartLinePathM');
            const mArea = document.getElementById('chartAreaPathM');
            const mDot = document.getElementById('chartDotM');
            if (mLine) { mLine.setAttribute('d', lineD); }
            if (mArea) { mArea.setAttribute('d', areaD); }
            if (mDot) { mDot.setAttribute('cx', lastX); mDot.setAttribute('cy', lastY); mDot.style.display = ''; }

            // Time labels
            const first = new Date(filtered[0].ts * 1000);
            const mid = new Date(((filtered[0].ts + lastPt.ts) / 2) * 1000);
            const late = new Date(((filtered[0].ts * 0.25 + lastPt.ts * 0.75)) * 1000);
            const fmt = d => d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            $('timeLabel1').textContent = fmt(first);
            $('timeLabel2').textContent = fmt(mid);
            $('timeLabel3').textContent = fmt(late);
            if ($('timeLabelM1')) { $('timeLabelM1').textContent = fmt(first); }
            if ($('timeLabelM2')) { $('timeLabelM2').textContent = fmt(mid); }
            if ($('timeLabelM3')) { $('timeLabelM3').textContent = fmt(late); }
        }

        function setChartRange(minutes) {
            chartRange = minutes;
            // Update button states
            document.querySelectorAll('.chart-range-btn, .chart-range-btn-m').forEach(btn => {
                btn.className = btn.className.replace(/bg-white dark:bg-primary text-primary dark:text-white shadow-sm font-medium/g, 'text-slate-500 hover:text-primary dark:hover:text-white');
                btn.classList.remove('active-range');
            });
            event.target.className = event.target.className.replace('text-slate-500 hover:text-primary dark:hover:text-white', 'bg-white dark:bg-primary text-primary dark:text-white shadow-sm font-medium');
            event.target.classList.add('active-range');
            renderChart();
        }

        // ---- Toast Notifications ----
        function showToast(data) {
            const container = $('toastContainer');
            const toast = document.createElement('div');
            const levelName = (data.new_level || 'INFO');
            const colorMap = { 'WARNING': 'border-l-yellow-500 bg-yellow-500/5', 'DANGER': 'border-l-orange-500 bg-orange-500/5', 'CRITICAL': 'border-l-red-500 bg-red-500/5' };
            const cls = colorMap[levelName] || 'border-l-primary bg-primary/5';

            toast.className = `toast-animate p-3 rounded-lg bg-white dark:bg-panel-dark border border-slate-200 dark:border-slate-700 border-l-4 ${cls} shadow-xl min-w-[260px] max-w-[350px]`;
            toast.innerHTML = `
            <p class="text-xs font-bold text-slate-800 dark:text-white">âš ï¸ ${levelName}</p>
            <p class="text-[10px] text-slate-500 mt-0.5">${data.message || 'Alert triggered'}</p>
        `;
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
        }

        // ---- Periodic Status Poll ----
        function pollStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // Camera
                    if (data.camera) {
                        if (data.camera.connected) {
                            $('videoOverlay').style.display = 'none';
                            $('cameraSourceBadge').textContent = data.camera.source;
                            $('cameraSourceBadge').classList.remove('hidden');
                            $('fpsDisplay').textContent = (data.camera.fps || 0).toFixed(0);
                            $('liveDot').classList.add('animate-pulse');
                        } else {
                            $('videoOverlay').style.display = '';
                            $('liveDot').classList.remove('animate-pulse');
                        }
                    }

                    // Uptime
                    if (data.system) {
                        const secs = Math.floor(data.system.uptime || 0);
                        const d = Math.floor(secs / 86400);
                        const h = Math.floor((secs % 86400) / 3600);
                        const m = Math.floor((secs % 3600) / 60);
                        $('uptimeDisplay').textContent = d > 0 ? `UP: ${d}d ${String(h).padStart(2, '0')}h` : `UP: ${h}h ${String(m).padStart(2, '0')}m`;
                    }

                    // Channels
                    if (data.alert && data.alert.channels) {
                        const ch = data.alert.channels;
                        setChannel('chWeb', ch.dashboard !== false);
                        setChannel('chSms', ch.sms === true);
                        setChannel('chBle', ch.ble === true);
                        setChannel('chChat', ch.briar === true);
                        setChannel('chTelegram', ch.telegram === true);
                    }
                })
                .catch(() => { });
        }

        function setChannel(id, active) {
            const el = $(id);
            if (active) {
                el.className = el.className.replace(/text-slate-300 dark:text-slate-600/g, 'text-emerald-500');
                if (!el.className.includes('text-emerald-500')) el.className += ' text-emerald-500';
                const label = el.querySelector('span:last-child');
                if (label) label.className = label.className.replace(/text-\[10px\]/, 'text-[10px] font-bold');
            } else {
                el.className = el.className.replace(/text-emerald-500/g, 'text-slate-300 dark:text-slate-600');
            }
        }

        // ---- Actions ----
        function testAlert() {
            fetch('/api/test_alert', { method: 'POST' })
                .then(r => r.json())
                .then(() => showToast({ new_level: 'WARNING', message: 'Test alert sent through all channels' }))
                .catch(e => console.error(e));
        }

        function stopSystem() {
            if (confirm('Stop the monitoring system?')) {
                // Could call a shutdown endpoint
                showToast({ new_level: 'WARNING', message: 'System stop requested' });
            }
        }

        // ---- Video feed error handling ----
        $('videoFeed').addEventListener('error', () => { $('videoOverlay').style.display = ''; });

        // ---- Modals & Settings ----
        function openSettingsModal() {
            const modal = $('settingsModal');
            const content = $('settingsModalContent');
            modal.classList.remove('hidden');

            // Fetch current settings
            fetch('/api/settings')
                .then(r => r.json())
                .then(data => {
                    $('cfgDeviceId').value = data.sms_device_id || '';
                    $('cfgRecipients').value = data.sms_recipients || '';
                });

            // Animate in
            setTimeout(() => {
                modal.classList.replace('opacity-0', 'opacity-100');
                content.classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function closeSettingsModal() {
            const modal = $('settingsModal');
            const content = $('settingsModalContent');

            modal.classList.replace('opacity-100', 'opacity-0');
            content.classList.replace('scale-100', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function saveSettings() {
            const payload = {
                sms_device_id: $('cfgDeviceId').value,
                sms_recipients: $('cfgRecipients').value
            };

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(() => {
                    closeSettingsModal();
                    showToast({ new_level: 'NORMAL', message: 'Settings saved successfully' });
                })
                .catch(e => {
                    showToast({ new_level: 'DANGER', message: 'Failed to save settings' });
                    console.error(e);
                });
        }


        // ---- Settings Tab Switching ----
        function switchTab(tabId) {
            // Hide all panels
            document.querySelectorAll('.settings-tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            // Show targeted panel
            document.getElementById('tab-' + tabId).classList.remove('hidden');

            // Update sidebar buttons
            document.querySelectorAll('[id^="tab-btn-"]').forEach(btn => {
                btn.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-left group";
            });
            const activeBtn = document.getElementById('tab-btn-' + tabId);
            if (activeBtn) {
                activeBtn.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary transition-colors text-left group border-l-2 border-primary";
            }

            // Update mobile select
            const mobileSelect = document.getElementById('mobileTabSelect');
            if (mobileSelect) mobileSelect.value = tabId;

            // Re-calculate the Canvas size once the element is no longer display: none !important
            if (tabId === 'camera') {
                setTimeout(setupROICanvas, 50);
            }
        }

        function saveCameraSettings() {
            // Need to save to API
            const newURL = `http://${$('cfgDroidCamIp').value}:${$('cfgDroidCamPort').value}/video`;
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera_url: newURL })
            }).then(r => r.json()).then(() => {
                showToast({ new_level: 'NORMAL', message: 'Camera settings saved. Restart required.' });
            });
        }

        function saveLevels() {
            // Save thresholds and ROI
            const payload = {
                thresholds: {
                    critical: parseInt($('cfgCrit').value),
                    danger: parseInt($('cfgDang').value),
                    warning: parseInt($('cfgWarn').value)
                }
            };

            // Use manual ROI inputs if valid, otherwise fallback to drawn ROI
            let manualY1 = parseInt($('cfgRoiY1').value);
            let manualY2 = parseInt($('cfgRoiY2').value);
            let manualX1 = parseInt($('cfgRoiX1').value);
            let manualX2 = parseInt($('cfgRoiX2').value);

            if (!isNaN(manualY1) && !isNaN(manualY2) && !isNaN(manualX1) && !isNaN(manualX2)) {
                payload.roi = [manualY1, manualY2, manualX1, manualX2];
            } else if (drawnROI && drawnROI.x2 > 0) {
                // Return array matching config format: [y1, y2, x1, x2]
                payload.roi = [drawnROI.y1, drawnROI.y2, drawnROI.x1, drawnROI.x2];
            }

            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(() => {
                showToast({ new_level: 'NORMAL', message: 'Calibration and ROI applied successfully.' });
            });
        }

        function saveNotificationRules() {
            showToast({ new_level: 'NORMAL', message: 'Notification rules saved.' });
        }

        function saveSmsSettings() {
            const payload = {
                sms_device_id: $('cfgDeviceId').value,
                sms_recipients: $('cfgRecipients').value
            };
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(() => {
                showToast({ new_level: 'NORMAL', message: 'SMS Configuration saved successfully' });
            });
        }

        function saveTgSettings() {
            const payload = {
                token: $('cfgTgToken').value,
                enabled: true
            };
            fetch('/api/telegram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(() => {
                showToast({ new_level: 'NORMAL', message: 'Telegram Token updated. Polling started.' });
            });
        }

        // OVERRIDE old saveSettings to avoid confusion
        function saveSettings() {
            console.log("Use specific save functions instead.");
        }

        // OVERRIDE old modal open to fetch all values
        function openSettingsModal() {
            const modal = $('settingsModal');
            const content = $('settingsModalContent');
            modal.classList.remove('hidden');

            // Siren state
            if ($('cfgSirenEnabled')) {
                $('cfgSirenEnabled').checked = siren.enabled;
            }

            fetch('/api/settings').then(r => r.json()).then(data => {
                $('cfgDeviceId').value = data.sms_device_id || '';
                $('cfgRecipients').value = data.sms_recipients || '';
            });

            fetch('/api/telegram').then(r => r.json()).then(data => {
                $('cfgTgToken').value = data.token || '';
                updateTgStatus(data);
            });

            fetch('/api/config').then(r => r.json()).then(data => {
                if (data.thresholds) {
                    $('cfgCrit').value = data.thresholds.critical || 290;
                    $('cfgDang').value = data.thresholds.danger || 260;
                    $('cfgWarn').value = data.thresholds.warning || 220;
                }
                if (data.camera_url) {
                    try {
                        let url = new URL(data.camera_url);
                        $('cfgDroidCamIp').value = url.hostname;
                        $('cfgDroidCamPort').value = url.port || '4747';
                        $('previewIp').innerText = url.hostname;
                        $('previewPort').innerText = url.port || '4747';
                    } catch (e) { }
                }
                if (data.roi) {
                    // pre-load existing ROI: [y_min, y_max, x_min, x_max]
                    drawnROI = {
                        y1: data.roi[0],
                        y2: data.roi[1],
                        x1: data.roi[2],
                        x2: data.roi[3]
                    };
                    $('cfgRoiY1').value = data.roi[0] !== null ? data.roi[0] : '';
                    $('cfgRoiY2').value = data.roi[1] !== null ? data.roi[1] : '';
                    $('cfgRoiX1').value = data.roi[2] !== null ? data.roi[2] : '';
                    $('cfgRoiX2').value = data.roi[3] !== null ? data.roi[3] : '';
                    drawCanvasRect();
                }
            });

            // Input listeners for preview
            $('cfgDroidCamIp').addEventListener('input', (e) => $('previewIp').innerText = e.target.value);
            $('cfgDroidCamPort').addEventListener('input', (e) => $('previewPort').innerText = e.target.value);

            // ROI manual listeners

            ['cfgRoiY1', 'cfgRoiY2', 'cfgRoiX1', 'cfgRoiX2'].forEach(id => {
                $(id).addEventListener('input', () => {
                    drawnROI = {
                        y1: parseInt($('cfgRoiY1').value) || 0,
                        y2: parseInt($('cfgRoiY2').value) || 0,
                        x1: parseInt($('cfgRoiX1').value) || 0,
                        x2: parseInt($('cfgRoiX2').value) || 0,
                    };
                    drawCanvasRect();
                });
            });

            setTimeout(() => {
                modal.classList.replace('opacity-0', 'opacity-100');
                content.classList.replace('scale-95', 'scale-100');
            }, 10);

            // Fetch active model and update UI
            fetch('/api/model').then(r => r.json()).then(data => {
                updateModelUI(data.active_model || 'canny');
            });



            switchTab('system'); // default tab
        }

        function updateTgStatus(data) {
            const idInput = $('cfgTgChatId');
            const badge = $('tgStatusBadge');

            if (data.chat_id) {
                idInput.value = data.chat_id;
                badge.innerText = "ACTIVE";
                badge.className = "px-2 py-0.5 rounded flex items-center justify-center bg-emerald-500 text-white text-[10px] font-bold";
            } else {
                idInput.value = "";
                badge.innerText = "WAITING...";
                badge.className = "px-2 py-0.5 rounded flex items-center justify-center bg-orange-500 text-white text-[10px] font-bold animate-pulse";
            }
        }

        // Periodically poll for registration when on telegram tab
        setInterval(() => {
            const tgTab = $('tab-telegram');
            if (tgTab && !tgTab.classList.contains('hidden')) {
                fetch('/api/telegram').then(r => r.json()).then(data => {
                    updateTgStatus(data);
                });
            }
        }, 5000);

        // ---- Model Selection ---
        let _activeModel = 'canny';

        function selectModel(model) {
            if (model === _activeModel) return;
            // Show loading toast
            showToast({ new_level: 'WARNING', message: 'Switching model to ' + model.toUpperCase() + '...' });
            fetch('/api/model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: model })
            }).then(r => r.json()).then(data => {
                if (data.active_model) {
                    updateModelUI(data.active_model);
                    showToast({ new_level: 'NORMAL', message: 'Switched to ' + data.active_model.toUpperCase() + ' model.' });
                }
            }).catch(() => {
                showToast({ new_level: 'DANGER', message: 'Failed to switch model.' });
            });
        }

        function updateModelUI(model) {
            _activeModel = model;
            const cannyCard = $('modelCard-canny');
            const stableCard = $('modelCard-stable');
            const cannyDot = $('modelDot-canny');
            const stableDot = $('modelDot-stable');

            if (model === 'stable') {
                // Stable active
                stableCard.className = 'cursor-pointer rounded-xl border-2 border-emerald-500 bg-emerald-500/5 p-5 flex gap-4 items-start transition-all hover:shadow-lg relative';
                stableDot.className = 'w-2.5 h-2.5 rounded-full bg-emerald-500';
                stableDot.parentElement.className = 'absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-emerald-500 flex items-center justify-center';

                cannyCard.className = 'cursor-pointer rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-transparent p-5 flex gap-4 items-start transition-all hover:shadow-lg relative';
                cannyDot.className = 'w-2.5 h-2.5 rounded-full bg-transparent';
                cannyDot.parentElement.className = 'absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center';
            } else {
                // Canny active
                cannyCard.className = 'cursor-pointer rounded-xl border-2 border-primary bg-primary/5 p-5 flex gap-4 items-start transition-all hover:shadow-lg relative';
                cannyDot.className = 'w-2.5 h-2.5 rounded-full bg-primary';
                cannyDot.parentElement.className = 'absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-primary flex items-center justify-center';

                stableCard.className = 'cursor-pointer rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-transparent p-5 flex gap-4 items-start transition-all hover:shadow-lg relative';
                stableDot.className = 'w-2.5 h-2.5 rounded-full bg-transparent';
                stableDot.parentElement.className = 'absolute top-3 right-3 w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center';
            }
        }

        // ==========================================
        // ROI Canvas Logic
        // ==========================================
        const roiCanvas = $('roiCanvas');
        const calibFeed = $('calibVideoFeed');
        let roiCtx = null;
        if (roiCanvas) roiCtx = roiCanvas.getContext('2d');

        function setupROICanvas() {
            if (!roiCanvas || !calibFeed) return;
            // Try to extract actual stream resolution if possible
            if (calibFeed.naturalWidth) {
                videoNaturalWidth = calibFeed.naturalWidth;
                videoNaturalHeight = calibFeed.naturalHeight;
            }
        }

        // Bulletproof auto-resizer to fix 0x0 bug when tabs switch
        if (roiCanvas) {
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const { width, height } = entry.contentRect;
                    if (width > 0 && height > 0) {
                        if (roiCanvas.width !== width || roiCanvas.height !== height) {
                            roiCanvas.width = width;
                            roiCanvas.height = height;
                            setupROICanvas(); // update video stream properties
                            if (drawnROI) drawCanvasRect();
                        }
                    }
                }
            });
            resizeObserver.observe(roiCanvas);
        }

        if (calibFeed) calibFeed.onload = setupROICanvas;

        let clickPoints = []; // Stores up to 2 clicks

        if (roiCanvas) {
            roiCanvas.addEventListener('click', (e) => {
                if (_activeModel === 'yolo') return; // Only used for Canny

                const rect = roiCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (clickPoints.length >= 2) {
                    // Reset on 3rd click to draw a new box
                    clickPoints = [];
                    drawnROI = null;
                    $('roiInstruction').innerHTML = `<span class="material-icons text-[14px] text-primary">touch_app</span> Click the <b>TOP-LEFT</b> corner of the ROI`;
                    roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
                }

                clickPoints.push({ x, y });

                if (clickPoints.length === 1) {
                    $('roiInstruction').innerHTML = `<span class="material-icons text-[14px] text-orange-400">touch_app</span> Click the <b>BOTTOM-RIGHT</b> corner`;
                    isDrawing = true;

                    // Immediately draw the point so user sees where they clicked
                    roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
                    roiCtx.beginPath();
                    roiCtx.arc(x, y, 5, 0, 2 * Math.PI);
                    roiCtx.fillStyle = '#10b981';
                    roiCtx.fill();

                } else if (clickPoints.length === 2) {
                    isDrawing = false;

                    const xMin = Math.min(clickPoints[0].x, clickPoints[1].x);
                    const xMax = Math.max(clickPoints[0].x, clickPoints[1].x);
                    const yMin = Math.min(clickPoints[0].y, clickPoints[1].y);
                    const yMax = Math.max(clickPoints[0].y, clickPoints[1].y);

                    // Ignore tiny clicks (accidental double clicks)
                    if (xMax - xMin < 10 || yMax - yMin < 10) {
                        clickPoints = [];
                        $('roiInstruction').innerHTML = `<span class="material-icons text-[14px] text-red-500">error</span> Too small. Click <b>TOP-LEFT</b> again.`;
                        roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
                        return;
                    }

                    // Map to Native Video pixels
                    const canvasRatio = roiCanvas.width / roiCanvas.height;
                    const videoRatio = videoNaturalWidth / videoNaturalHeight;

                    let renderedWidth, renderedHeight, offsetX, offsetY;

                    if (canvasRatio > videoRatio) {
                        renderedHeight = roiCanvas.height;
                        renderedWidth = renderedHeight * videoRatio;
                        offsetX = (roiCanvas.width - renderedWidth) / 2;
                        offsetY = 0;
                    } else {
                        renderedWidth = roiCanvas.width;
                        renderedHeight = renderedWidth / videoRatio;
                        offsetX = 0;
                        offsetY = (roiCanvas.height - renderedHeight) / 2;
                    }

                    const nativeXMin = Math.max(0, (xMin - offsetX) / renderedWidth) * videoNaturalWidth;
                    const nativeXMax = Math.min(1, (xMax - offsetX) / renderedWidth) * videoNaturalWidth;
                    const nativeYMin = Math.max(0, (yMin - offsetY) / renderedHeight) * videoNaturalHeight;
                    const nativeYMax = Math.min(1, (yMax - offsetY) / renderedHeight) * videoNaturalHeight;

                    drawnROI = {
                        x1: Math.round(nativeXMin),
                        x2: Math.round(nativeXMax),
                        y1: Math.round(nativeYMin),
                        y2: Math.round(nativeYMax)
                    };

                    // Sync textboxes 
                    if ($('cfgRoiY1')) {
                        $('cfgRoiY1').value = drawnROI.y1;
                        $('cfgRoiY2').value = drawnROI.y2;
                        $('cfgRoiX1').value = drawnROI.x1;
                        $('cfgRoiX2').value = drawnROI.x2;
                    }

                    $('roiInstruction').innerHTML = `<span class="material-icons text-[14px] text-emerald-400">check_circle</span> Web ROI Selected: ${drawnROI.x1},${drawnROI.y1} to ${drawnROI.x2},${drawnROI.y2}`;
                    drawCanvasRect();
                }
            });

            roiCanvas.addEventListener('mousemove', (e) => {
                if (clickPoints.length !== 1) return; // Only draw preview box if 1 point is clicked

                const rect = roiCanvas.getBoundingClientRect();
                const hoverX = e.clientX - rect.left;
                const hoverY = e.clientY - rect.top;

                roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);

                // Draw current preview box from point 1 to mouse hover
                roiCtx.strokeStyle = '#10b981';
                roiCtx.lineWidth = 2;
                roiCtx.setLineDash([5, 5]);

                const px1 = clickPoints[0].x;
                const py1 = clickPoints[0].y;
                roiCtx.strokeRect(px1, py1, hoverX - px1, hoverY - py1);

                roiCtx.fillStyle = 'rgba(16, 185, 129, 0.2)';
                roiCtx.fillRect(px1, py1, hoverX - px1, hoverY - py1);
                roiCtx.setLineDash([]);

                // Draw Point 1 Node again to keep it top-level
                roiCtx.beginPath();
                roiCtx.arc(px1, py1, 5, 0, 2 * Math.PI);
                roiCtx.fillStyle = '#10b981';
                roiCtx.fill();
            });

            // Allow cancelling with right click
            roiCanvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                clickPoints = [];
                isDrawing = false;
                $('roiInstruction').innerHTML = `<span class="material-icons text-[14px] text-primary">touch_app</span> Cancelled. Click <b>TOP-LEFT</b> of ROI`;
                roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
                if (drawnROI) drawCanvasRect(); // Restore existing if any
            });
        }

        function drawCanvasRect() {
            if (!roiCtx || !drawnROI) return;
            roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);

            // Map native ROI back to CSS rendering coordinates for display
            const canvasRatio = roiCanvas.width / roiCanvas.height;
            const videoRatio = videoNaturalWidth / videoNaturalHeight;
            let renderedWidth, renderedHeight, offsetX, offsetY;

            if (canvasRatio > videoRatio) {
                renderedHeight = roiCanvas.height;
                renderedWidth = renderedHeight * videoRatio;
                offsetX = (roiCanvas.width - renderedWidth) / 2;
                offsetY = 0;
            } else {
                renderedWidth = roiCanvas.width;
                renderedHeight = renderedWidth / videoRatio;
                offsetX = 0;
                offsetY = (roiCanvas.height - renderedHeight) / 2;
            }

            const cssX1 = (drawnROI.x1 / videoNaturalWidth) * renderedWidth + offsetX;
            const cssX2 = (drawnROI.x2 / videoNaturalWidth) * renderedWidth + offsetX;
            const cssY1 = (drawnROI.y1 / videoNaturalHeight) * renderedHeight + offsetY;
            const cssY2 = (drawnROI.y2 / videoNaturalHeight) * renderedHeight + offsetY;

            // Draw
            roiCtx.strokeStyle = '#10b981'; // Emerald
            roiCtx.lineWidth = 2;
            roiCtx.strokeRect(cssX1, cssY1, cssX2 - cssX1, cssY2 - cssY1);

            // Tint outside
            roiCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            roiCtx.fillRect(0, 0, roiCanvas.width, cssY1); // top
            roiCtx.fillRect(0, cssY1, cssX1, cssY2 - cssY1); // left
            roiCtx.fillRect(cssX2, cssY1, roiCanvas.width - cssX2, cssY2 - cssY1); // right
            roiCtx.fillRect(0, cssY2, roiCanvas.width, roiCanvas.height - cssY2); // bottom

            // Label
            roiCtx.fillStyle = '#10b981';
            roiCtx.font = "12px monospace";
            roiCtx.fillText("Active Web ROI", cssX1 + 4, cssY1 + 14);
        }

        // ---- Init ----
        pollStatus();
        setInterval(pollStatus, 3000);
    </script>

</body>

</html>